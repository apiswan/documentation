## Deploying GoReplay as a Sidecar in a Kubernetes Cluster

In this guide, you will learn how to set up GoReplay as a sidecar container alongside your main application within a Kubernetes cluster. This setup is valuable for capturing and examining network traffic, which can be utilized by the APISwan agent to autonomously create regression reports.

### Prerequisites

Before you begin, ensure that you have the following prerequisites:

- A running Kubernetes cluster.
- Kubernetes command-line tool (`kubectl`) installed and configured.
- A Dockerized version of your main application.
- Familiarity with Docker and containerization concepts.
- Basic knowledge of Kubernetes.

### Step 1: Create Kubernetes Deployment Configuration

1. Create a Kubernetes YAML file (e.g., `main-app-deployment.yaml`) to define your main application and GoReplay containers. Here's an example configuration:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: main-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: main-app
  template:
    metadata:
      labels:
        app: main-app
    spec:
      containers:
      - name: main-app
        image: your-main-app-image:latest
        ports:
        - containerPort: 8080
        # Add other configuration options for your main app if needed

      - name: goreplay
        image: goreplay/goreplay
        command: [
          "--input-raw", ":8080",
          "--input-raw-track-response",
          "--output-file", "/var/log/goreplay/swan-%d-%H-%M-%S.log"
        ]
        volumeMounts:
        - name: log-volume
          mountPath: /var/log/goreplay
        # Add other GoReplay configuration options if needed

  volumes:
  - name: log-volume
    emptyDir: {}
```

In this example, we create a Kubernetes Deployment with two containers: `main-app` and `goreplay`. The `main-app` container runs your main application, and the `goreplay` container runs GoReplay as a sidecar. GoReplay is configured to capture traffic on port 8080 and store logs in the `/var/log/goreplay` directory.

2. Save the Kubernetes YAML file in your project directory.

### Step 2: Deploy to Kubernetes

1. Apply the deployment configuration to your Kubernetes cluster:

```bash
kubectl apply -f main-app-deployment.yaml
```

This will create the main application and GoReplay containers in your Kubernetes cluster.

### Step 3: Testing

1. To verify that GoReplay is capturing and forwarding traffic as expected, you can make HTTP requests to your main application:

   ```bash
   kubectl port-forward deployment/main-app 8080:8080
   ```

   Now, you can access your main application locally at http://localhost:8080.

   Observe the traffic capture in the GoReplay container's logs.

2. Test your application as you normally would, and check for `swan-*.log` files generated by GoReplay to capture traffic within the pod.

### Step 4: Monitoring and Logging

You can monitor and log the behavior of your main application and GoReplay as needed. Consider configuring logging options within your main application and using Kubernetes logging for the GoReplay container.

### Step 5: Cleanup

To delete the deployed resources when you're finished, run the following command:

```bash
kubectl delete -f main-app-deployment.yaml
```

## Conclusion

You have successfully set up GoReplay as a sidecar container alongside your main application in a Kubernetes cluster. This setup simplifies the process of capturing and examining network traffic, which can be leveraged by the APISwan agent to create regression reports. Adjust the Kubernetes deployment configuration and GoReplay options to meet your specific requirements.
